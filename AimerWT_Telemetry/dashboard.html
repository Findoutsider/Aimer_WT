<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AimerWT | 遥测数据仪表盘 v1</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg: #f6f8fb;
            --card: #ffffff;
            --primary: #2563eb;
            --primary-soft: rgba(37, 99, 235, 0.12);
            --secondary: #10b981;
            --secondary-soft: rgba(16, 185, 129, 0.12);
            --warning: #f59e0b;
            --danger: #ef4444;
            --text: #1f2937;
            --text-muted: #6b7280;
            --border: #e5e7eb;
            --shadow: 0 10px 24px rgba(15, 23, 42, 0.06);
        }

        @keyframes pulse-green {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            }

            70% {
                transform: scale(1);
                box-shadow: 0 0 0 4px rgba(16, 185, 129, 0);
            }

            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }

        .status-dot.online {
            background-color: var(--secondary);
            animation: pulse-green 2s infinite;
        }

        .status-dot.offline {
            background-color: var(--danger);
        }

        .hwid-cell {
            cursor: pointer;
            user-select: none;
        }

        .hwid-toast {
            position: fixed;
            background: rgba(15, 23, 42, 0.92);
            color: #fff;
            font-size: 12px;
            padding: 6px 10px;
            border-radius: 8px;
            z-index: 9999;
            opacity: 0;
            transform: translateY(-6px);
            transition: opacity 0.2s ease, transform 0.2s ease;
            pointer-events: none;
        }

        .hwid-toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            min-height: 100vh;
            overflow: hidden;
        }

        .layout-wrapper {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        .sidebar {
            width: 260px;
            background: #fff;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            z-index: 10;
        }

        .sidebar-header {
            padding: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid transparent;
        }

        .sidebar-logo {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: linear-gradient(135deg, #1d4ed8, #3b82f6);
            color: #fff;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }

        .sidebar-brand h1 {
            font-size: 18px;
            font-weight: 700;
            line-height: 1.2;
        }

        .sidebar-brand p {
            font-size: 12px;
            color: var(--text-muted);
        }

        .sidebar-menu {
            padding: 16px;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 10px;
            cursor: pointer;
            color: var(--text-muted);
            transition: all 0.2s;
            font-size: 14px;
            font-weight: 500;
        }

        .menu-item:hover {
            background: var(--bg);
            color: var(--text);
        }

        .menu-item.active {
            background: var(--primary-soft);
            color: var(--primary);
            font-weight: 600;
        }

        .menu-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 6px;
        }

        .menu-item.active .menu-icon {
            background: rgba(37, 99, 235, 0.2);
        }

        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            background: var(--bg);
            position: relative;
        }

        .view-container {
            display: none;
            max-width: 1500px;
            margin: 0 auto;
            animation: fadeIn 0.3s ease;
        }

        .view-container.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(4px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            margin-bottom: 20px;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .logo {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: linear-gradient(135deg, #1d4ed8, #3b82f6);
            color: #fff;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
        }

        .brand-text h1 {
            font-size: 20px;
            font-weight: 700;
        }

        .brand-text p {
            font-size: 12px;
            color: var(--text-muted);
        }

        .top-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .btn {
            border: 1px solid var(--border);
            background: #fff;
            color: var(--text);
            padding: 8px 14px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn.primary {
            background: var(--primary);
            color: #fff;
            border-color: transparent;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .btn.loading {
            position: relative;
            padding-right: 30px;
        }

        .btn.loading::after {
            content: '';
            position: absolute;
            right: 10px;
            top: 50%;
            width: 12px;
            height: 12px;
            margin-top: -6px;
            border-radius: 50%;
            border: 2px solid rgba(37, 99, 235, 0.35);
            border-top-color: #2563eb;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .toolbar {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
        }

        .toolbar-card {
            flex: 1;
            background: var(--card);
            border-radius: 16px;
            padding: 14px 16px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
            transition: opacity 0.25s ease, transform 0.25s ease;
        }

        .toolbar-title {
            font-weight: 600;
            font-size: 13px;
            color: var(--text-muted);
            margin-right: 8px;
        }

        .select,
        .input {
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 7px 10px;
            font-size: 13px;
            background: #fff;
            color: var(--text);
        }

        .alerts {
            display: grid;
            gap: 10px;
            margin-bottom: 16px;
        }

        .alert {
            padding: 12px 14px;
            border-radius: 12px;
            font-size: 13px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid transparent;
            opacity: 0;
            transform: translateY(-6px);
            transition: opacity 0.25s ease, transform 0.25s ease;
        }

        .alert.show {
            opacity: 1;
            transform: translateY(0);
        }

        .alert.warning {
            background: rgba(245, 158, 11, 0.12);
            border-color: rgba(245, 158, 11, 0.3);
            color: #92400e;
        }

        .alert.danger {
            background: rgba(239, 68, 68, 0.12);
            border-color: rgba(239, 68, 68, 0.3);
            color: #991b1b;
        }

        .alert.success {
            background: rgba(16, 185, 129, 0.12);
            border-color: rgba(16, 185, 129, 0.3);
            color: #065f46;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }

        .kpi-card {
            background: var(--card);
            border-radius: 16px;
            padding: 18px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            gap: 10px;
            transition: opacity 0.25s ease, transform 0.25s ease;
        }

        .kpi-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 13px;
            color: var(--text-muted);
        }

        .kpi-value {
            font-size: 32px;
            font-weight: 700;
        }

        .kpi-meta {
            display: flex;
            gap: 10px;
            align-items: center;
            font-size: 12px;
        }

        .trend {
            padding: 3px 8px;
            border-radius: 999px;
            font-weight: 600;
        }

        .trend.up {
            background: var(--secondary-soft);
            color: var(--secondary);
        }

        .trend.down {
            background: rgba(239, 68, 68, 0.12);
            color: var(--danger);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }

        .panel {
            background: var(--card);
            border-radius: 18px;
            padding: 16px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            gap: 14px;
            transition: opacity 0.25s ease, transform 0.25s ease;
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .panel-title {
            font-size: 15px;
            font-weight: 700;
        }

        .panel-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .panel-sub {
            font-size: 12px;
            color: var(--text-muted);
        }

        .chart {
            width: 100%;
            height: 320px;
        }

        .chart.sm {
            height: 260px;
        }

        .span-8 {
            grid-column: span 8;
        }

        .span-4 {
            grid-column: span 4;
        }

        .span-3 {
            grid-column: span 3;
        }

        .span-6 {
            grid-column: span 6;
        }

        .compare-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .compare-tag {
            background: var(--primary-soft);
            color: var(--primary);
            padding: 4px 8px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
        }

        .recent-list {
            display: grid;
            gap: 14px;
            max-height: 426px;
            overflow-y: auto;
            padding-right: 4px;
        }

        .recent-list::-webkit-scrollbar {
            width: 4px;
        }

        .recent-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .recent-list::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .recent-list::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .recent-item {
            display: grid;
            grid-template-columns: 48px 1fr auto;
            gap: 14px;
            align-items: center;
            padding: 0 12px;
            height: 74px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: #fff;
            transition: opacity 0.25s ease, transform 0.25s ease, box-shadow 0.25s ease, border-color 0.25s ease;
        }

        .recent-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #60a5fa, #2563eb);
            color: #fff;
            font-weight: 700;
            font-size: 13px;
        }

        .recent-main {
            display: grid;
            gap: 2px;
        }

        .recent-name {
            font-weight: 600;
            font-size: 14px;
            line-height: 1.4;
        }

        .recent-meta {
            color: var(--text-muted);
            font-size: 12px;
            line-height: 1.3;
        }

        .recent-time {
            font-size: 12px;
            color: var(--text-muted);
            text-align: right;
        }

        .recent-item.active {
            border-color: rgba(37, 99, 235, 0.4);
            box-shadow: 0 8px 18px rgba(37, 99, 235, 0.08);
        }

        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        .detail-grid.switching {
            opacity: 0;
            transform: translateY(6px);
        }

        .detail-card {
            padding: 0 12px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: #fff;
            display: grid;
            gap: 6px;
            height: 74px;
            align-items: center;
            align-content: center;
            transition: opacity 0.25s ease, transform 0.25s ease;
        }

        .app.refreshing .panel,
        .app.refreshing .kpi-card,
        .app.refreshing .toolbar-card,
        .app.refreshing .recent-item,
        .app.refreshing .detail-card {
            opacity: 0.65;
            transform: translateY(2px);
        }

        .detail-label {
            font-size: 12px;
            color: var(--text-muted);
        }

        .detail-value {
            font-size: 14px;
            font-weight: 600;
        }

        .drawer-mask {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.4);
            opacity: 0;
            pointer-events: none;
            transition: all 0.2s;
        }

        .drawer-mask.show {
            opacity: 1;
            pointer-events: auto;
        }

        .drawer {
            position: fixed;
            top: 0;
            right: 0;
            width: 360px;
            height: 100%;
            background: #fff;
            box-shadow: -8px 0 24px rgba(15, 23, 42, 0.2);
            transform: translateX(100%);
            transition: transform 0.25s;
            display: flex;
            flex-direction: column;
        }

        .drawer.show {
            transform: translateX(0);
        }

        .drawer-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .drawer-body {
            padding: 16px;
            display: grid;
            gap: 12px;
            overflow-y: auto;
        }

        .drawer-card {
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 10px 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 13px;
        }

        .muted {
            color: var(--text-muted);
        }

        @media (max-width: 1200px) {
            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .span-8,
            .span-4,
            .span-6,
            .span-3 {
                grid-column: span 12;
            }
        }

        @media (max-width: 900px) {
            .topbar {
                flex-direction: column;
                align-items: flex-start;
            }

            .toolbar {
                grid-template-columns: 1fr;
            }
        }

        .modal-mask {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            z-index: 998;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-mask.show {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            background: #fff;
            padding: 24px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            z-index: 999;
            width: 440px;
            max-width: 90vw;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-header h3 {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-body {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--text-muted);
            font-weight: 500;
        }

        .date-range-inputs {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .date-range-inputs .input {
            flex: 1;
        }

        .modal-footer {
            margin-top: 32px;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .btn-icon {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 20px;
            color: var(--text-muted);
            padding: 4px;
            line-height: 1;
        }

        .btn-icon:hover {
            color: var(--text);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .data-table th {
            font-weight: 600;
            color: var(--text-muted);
            font-size: 13px;
            background: #f8fafc;
        }

        .data-table td {
            font-size: 14px;
        }

        .data-table tr:hover {
            background: #f8fafc;
        }
    </style>
</head>

<body>
    <div class="layout-wrapper">
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">A</div>
                <div class="sidebar-brand">
                    <h1>遥测数据仪表盘</h1>
                    <p>123123 指标总览</p>
                </div>
            </div>
            <div class="sidebar-menu">
                <div class="menu-item active" onclick="switchView('dashboard', this)">
                    <div class="menu-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="7" height="7"></rect>
                            <rect x="14" y="3" width="7" height="7"></rect>
                            <rect x="14" y="14" width="7" height="7"></rect>
                            <rect x="3" y="14" width="7" height="7"></rect>
                        </svg>
                    </div>
                    <span>主页</span>
                </div>
                <div class="menu-item" onclick="switchView('control', this)">
                    <div class="menu-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path
                                d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z">
                            </path>
                        </svg>
                    </div>
                    <span>操控</span>
                </div>
                <div class="menu-item" onclick="switchView('userlist', this)">
                    <div class="menu-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                    </div>
                    <span>用户列表</span>
                </div>
                <div class="menu-item" onclick="switchView('userdetail', this)">
                    <div class="menu-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                    </div>
                    <span>用户详情</span>
                </div>
                <div class="menu-item" onclick="switchView('analysis', this)">
                    <div class="menu-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="20" x2="18" y2="10"></line>
                            <line x1="12" y1="20" x2="12" y2="4"></line>
                            <line x1="6" y1="20" x2="6" y2="14"></line>
                        </svg>
                    </div>
                    <span>数据分析</span>
                </div>
                <div class="menu-item" onclick="switchView('settings', this)">
                    <div class="menu-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path
                                d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                            </path>
                        </svg>
                    </div>
                    <span>设置</span>
                </div>
            </div>
        </div>
        <div class="main-content">
            <div id="view-dashboard" class="view-container active">
                <div class="app">

                    <div class="toolbar">
                        <div class="toolbar-card">
                            <span class="toolbar-title">数据筛选</span>
                            <select class="select" id="filterOS" onchange="applyFilters()">
                                <option value="">全部操作系统</option>
                            </select>
                            <select class="select" id="filterArch" onchange="applyFilters()">
                                <option value="">全部架构</option>
                            </select>
                            <select class="select" id="filterVersion" onchange="applyFilters()">
                                <option value="">全部版本</option>
                            </select>
                            <select class="select" id="filterLocale" onchange="applyFilters()">
                                <option value="">全部区域</option>
                            </select>

                            <div style="margin-left: auto; display: flex; align-items: center; gap: 12px;">
                                <div class="muted" id="lastUpdate">最近更新 -</div>
                                <button class="btn" id="refreshBtn" onclick="refreshData()">刷新数据</button>
                                <button class="btn primary" onclick="handleControl('export')">导出数据</button>
                            </div>
                        </div>
                    </div>

                    <div class="alerts" id="alertContainer"></div>

                    <div class="kpi-grid">
                        <div class="kpi-card" id="kpiTotal">
                            <div class="kpi-header">
                                <span>总用户量</span>
                                <span class="muted">累计</span>
                            </div>
                            <div class="kpi-value" id="totalUsers">-</div>
                            <div class="kpi-meta">
                                <span class="trend up" id="totalUsersTrend">↑ 0%</span>
                                <span class="muted">累计增长率</span>
                            </div>
                        </div>
                        <div class="kpi-card" id="kpiOnline">
                            <div class="kpi-header">
                                <span>在线用户</span>
                                <span class="muted">实时</span>
                            </div>
                            <div class="kpi-value" id="onlineUsers">-</div>
                            <div class="kpi-meta">
                                <span class="trend up" id="onlineRate">在线率 0%</span>
                                <span class="muted">当前在线</span>
                            </div>
                        </div>
                        <div class="kpi-card" id="kpiToday">
                            <div class="kpi-header">
                                <span>今日新增</span>
                                <span class="muted">日增</span>
                            </div>
                            <div class="kpi-value" id="todayNew">-</div>
                            <div class="kpi-meta">
                                <span class="trend up" id="todayNewTrend">↑ 0%</span>
                                <span class="muted">环比</span>
                            </div>
                        </div>
                        <div class="kpi-card" id="kpiDau">
                            <div class="kpi-header">
                                <span>日活跃用户</span>
                                <span class="muted">DAU</span>
                            </div>
                            <div class="kpi-value" id="dauUsers">-</div>
                            <div class="kpi-meta">
                                <span class="trend up" id="dauTrend">↑ 0%</span>
                                <span class="muted">环比</span>
                            </div>
                        </div>
                    </div>

                    <div class="grid">
                        <div class="panel span-8">
                            <div class="panel-header">
                                <div>
                                    <div class="panel-title">用户增长趋势</div>
                                    <div class="panel-sub" id="growthPeakInfo">峰值 -</div>
                                </div>
                                <div class="panel-actions">
                                    <select class="select" id="trendRange" onchange="applyFilters()">
                                        <option value="7">近7天</option>
                                        <option value="14">近14天</option>
                                        <option value="30" selected>近30天</option>
                                        <option value="90">近90天</option>
                                    </select>
                                    <div class="compare-bar">
                                        <span class="compare-tag">对比</span>
                                        <input class="input" type="date" id="compareStart">
                                        <span class="muted">至</span>
                                        <input class="input" type="date" id="compareEnd">
                                        <button class="btn" onclick="applyFilters()">应用</button>
                                    </div>
                                </div>
                            </div>
                            <div class="chart" id="growthChart"></div>
                        </div>
                        <div class="panel span-4">
                            <div class="panel-header">
                                <div>
                                    <div class="panel-title">新增与日活对比</div>
                                    <div class="panel-sub">趋势对比</div>
                                </div>
                            </div>
                            <div class="chart" id="newVsDauChart"></div>
                        </div>
                    </div>

                    <div class="grid">
                        <div class="panel span-3">
                            <div class="panel-header">
                                <div class="panel-title">操作系统分布</div>
                            </div>
                            <div class="chart sm" id="osChart"></div>
                        </div>
                        <div class="panel span-3">
                            <div class="panel-header">
                                <div class="panel-title">架构分布</div>
                            </div>
                            <div class="chart sm" id="archChart"></div>
                        </div>
                        <div class="panel span-3">
                            <div class="panel-header">
                                <div class="panel-title">软件版本分布</div>
                            </div>
                            <div class="chart sm" id="versionChart"></div>
                        </div>
                        <div class="panel span-3">
                            <div class="panel-header">
                                <div class="panel-title">区域分布</div>
                            </div>
                            <div class="chart sm" id="localeChart"></div>
                        </div>
                    </div>

                    <div class="grid">
                        <div class="panel span-6">
                            <div class="panel-header">
                                <div>
                                    <div class="panel-title">最新活跃用户</div>
                                    <div class="panel-sub">最近更新的在线用户</div>
                                </div>
                            </div>
                            <div class="recent-list" id="recentUsersList"></div>
                        </div>
                        <div class="panel span-6">
                            <div class="panel-header">
                                <div>
                                    <div class="panel-title">用户详细信息</div>
                                    <div class="panel-sub" id="userDetailSub">点击左侧用户查看详情</div>
                                </div>
                            </div>
                            <div class="detail-grid" id="userDetailGrid"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-userlist" class="view-container">
                <div class="app">
                    <div class="topbar">
                        <div class="top-actions" style="margin-left: auto;">
                            <button class="btn" onclick="refreshData()">刷新列表</button>
                        </div>
                    </div>
                    <div class="panel">
                        <div class="panel-header">
                            <h3>用户列表</h3>
                        </div>
                        <div class="panel-body" style="padding: 0;">
                            <div style="overflow-x: auto;">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>用户</th>
                                            <th>HWID</th>
                                            <th>版本</th>
                                            <th>系统</th>
                                            <th>区域</th>
                                            <th>最近活跃</th>
                                            <th>状态</th>
                                        </tr>
                                    </thead>
                                    <tbody id="fullUserListBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-userdetail" class="view-container" style="max-width: 98%;">
                <div class="app">
                    <div class="topbar">
                        <div class="top-actions" style="margin-left: auto;">
                            <button class="btn"
                                onclick="switchView('userlist', document.querySelectorAll('.menu-item')[1])">返回列表</button>
                        </div>
                    </div>
                    <div class="panel">
                        <div class="panel-header">
                            <h3>用户详情</h3>
                        </div>
                        <div class="panel-body" style="padding: 24px;">
                            <div id="userDetailContent">
                                <div style="text-align: center; color: var(--text-muted); padding: 40px;">
                                    请先在用户列表中选择一个用户
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-analysis" class="view-container">
                <div class="app">
                    <div class="topbar">
                        <div class="top-actions" style="margin-left: auto;">
                            <button class="btn" onclick="refreshData()">刷新分析</button>
                        </div>
                    </div>
                    <div class="panel">
                        <div class="panel-header">
                            <h3>数据分析</h3>
                        </div>
                        <div class="panel-body" style="padding: 24px;">
                            <div style="text-align: center; color: var(--text-muted); padding: 40px;">
                                功能开发中...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-settings" class="view-container">
                <div class="app">
                    <div class="topbar">
                        <div class="top-actions" style="margin-left: auto;">
                            <button class="btn primary" onclick="showAlert('设置已保存', 'success')">保存设置</button>
                        </div>
                    </div>
                    <div class="panel">
                        <div class="panel-header">
                            <h3>系统设置</h3>
                        </div>
                        <div class="panel-body" style="padding: 24px;">
                            <div
                                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 32px; max-width: 1000px;">

                                <div style="display: flex; flex-direction: column; gap: 20px;">
                                    <h4
                                        style="border-bottom: 1px solid var(--border); padding-bottom: 10px; color: var(--text-muted); font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">
                                        界面与显示</h4>

                                    <div class="form-group">
                                        <label>界面主题</label>
                                        <select class="select" style="width: 100%;">
                                            <option value="light">浅色模式</option>
                                            <option value="dark">深色模式</option>
                                            <option value="auto">跟随系统</option>
                                        </select>
                                    </div>

                                    <div class="form-group">
                                        <label>仪表盘布局</label>
                                        <select class="select" style="width: 100%;">
                                            <option value="comfortable">舒适 (默认)</option>
                                            <option value="compact">紧凑</option>
                                        </select>
                                    </div>

                                    <div class="form-group">
                                        <label>图表动画</label>
                                        <div style="display: flex; gap: 12px; flex-direction: column;">
                                            <label
                                                style="display: flex; align-items: center; gap: 8px; font-weight: normal; cursor: pointer;">
                                                <input type="checkbox" checked> 启用平滑过渡动画
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <div style="display: flex; flex-direction: column; gap: 20px;">
                                    <h4
                                        style="border-bottom: 1px solid var(--border); padding-bottom: 10px; color: var(--text-muted); font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">
                                        数据与行为</h4>

                                    <div class="form-group">
                                        <label>自动刷新间隔</label>
                                        <select class="select" style="width: 100%;">
                                            <option value="30">30秒</option>
                                            <option value="60" selected>1分钟</option>
                                            <option value="300">5分钟</option>
                                            <option value="0">关闭自动刷新</option>
                                        </select>
                                    </div>

                                    <div class="form-group">
                                        <label>默认时间范围</label>
                                        <select class="select" style="width: 100%;">
                                            <option value="7">最近 7 天</option>
                                            <option value="30" selected>最近 30 天</option>
                                            <option value="90">最近 90 天</option>
                                        </select>
                                    </div>

                                    <div class="form-group">
                                        <label>通知设置</label>
                                        <div style="display: flex; gap: 12px; flex-direction: column;">
                                            <label
                                                style="display: flex; align-items: center; gap: 8px; font-weight: normal; cursor: pointer;">
                                                <input type="checkbox" checked> 启用桌面通知
                                            </label>
                                            <label
                                                style="display: flex; align-items: center; gap: 8px; font-weight: normal; cursor: pointer;">
                                                <input type="checkbox" checked> 播放提示音
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <div style="display: flex; flex-direction: column; gap: 20px;">
                                    <h4
                                        style="border-bottom: 1px solid var(--border); padding-bottom: 10px; color: var(--text-muted); font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">
                                        高级选项</h4>

                                    <div class="form-group">
                                        <label>默认导出格式</label>
                                        <select class="select" style="width: 100%;">
                                            <option value="csv">CSV (逗号分隔)</option>
                                            <option value="excel">Excel (.xlsx)</option>
                                            <option value="json">JSON (原始数据)</option>
                                        </select>
                                    </div>

                                    <div class="form-group">
                                        <label>数据保留策略</label>
                                        <select class="select" style="width: 100%;">
                                            <option value="7">保留7天</option>
                                            <option value="30" selected>保留30天</option>
                                            <option value="90">保留90天</option>
                                            <option value="0">永久保留</option>
                                        </select>
                                    </div>

                                    <div class="form-group">
                                        <label>调试模式</label>
                                        <div style="display: flex; gap: 12px; flex-direction: column;">
                                            <label
                                                style="display: flex; align-items: center; gap: 8px; font-weight: normal; cursor: pointer;">
                                                <input type="checkbox"> 显示原始 API 响应
                                            </label>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-control" class="view-container">
                <div class="app">
                    <div class="topbar">
                        <div class="top-actions" style="margin-left: auto;">
                            <button class="btn" onclick="showAlert('状态已同步', 'success')">同步状态</button>
                        </div>
                    </div>
                    <div class="grid">
                        <div class="panel span-4">
                            <div class="panel-header">
                                <div class="panel-title">维护模式</div>
                            </div>
                            <div class="panel-body"
                                style="padding: 10px 0; display: flex; flex-direction: column; height: 100%;">
                                <p class="muted" style="margin-bottom: 20px; font-size: 13px; flex: 1;">
                                    开启后仅白名单用户可访问，适用于服务器停机维护或版本迁移。</p>
                                <button class="btn primary" style="justify-content: center;"
                                    onclick="handleControl('maintenance')">设置维护状态</button>
                            </div>
                        </div>
                        <div class="panel span-4">
                            <div class="panel-header">
                                <div class="panel-title">发布紧急通知</div>
                            </div>
                            <div class="panel-body"
                                style="padding: 10px 0; display: flex; flex-direction: column; height: 100%;">
                                <p class="muted" style="margin-bottom: 20px; font-size: 13px; flex: 1;">
                                    弹窗提示。向客户端推送即时模态弹窗，适用于重大更新或维护通知。</p>
                                <button class="btn primary" style="justify-content: center;"
                                    onclick="handleControl('alert')">发布紧急通知</button>
                            </div>
                        </div>
                        <div class="panel span-4">
                            <div class="panel-header">
                                <div class="panel-title">发布公告栏</div>
                            </div>
                            <div class="panel-body"
                                style="padding: 10px 0; display: flex; flex-direction: column; height: 100%;">
                                <p class="muted" style="margin-bottom: 20px; font-size: 13px; flex: 1;">
                                    文字覆盖。远程修改客户端顶部的滚动/静态公告栏文字內容。</p>
                                <button class="btn primary" style="justify-content: center;"
                                    onclick="handleControl('notice')">发布公告栏文字</button>
                            </div>
                        </div>
                        <div class="panel span-4">
                            <div class="panel-header">
                                <div class="panel-title">更新提示</div>
                            </div>
                            <div class="panel-body"
                                style="padding: 10px 0; display: flex; flex-direction: column; height: 100%;">
                                <p class="muted" style="margin-bottom: 20px; font-size: 13px; flex: 1;">
                                    向客户端推送更新提示，可设置推送范围与内容。</p>
                                <button class="btn primary" style="justify-content: center;"
                                    onclick="handleControl('update')">发布更新提示</button>
                            </div>
                        </div>
                        <div class="panel span-4">
                            <div class="panel-header">
                                <div class="panel-title">JSON 测试接口</div>
                            </div>
                            <div class="panel-body"
                                style="padding: 10px 0; display: flex; flex-direction: column; height: 100%;">
                                <p class="muted" style="margin-bottom: 20px; font-size: 13px; flex: 1;">仅用于前端联调与数据结构校验。
                                </p>
                                <button class="btn" style="justify-content: center;"
                                    onclick="handleControl('test')">打开测试接口</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div class="modal-mask" id="controlModalMask" onclick="closeControlModal()"></div>
    <div class="modal" id="controlModal">
        <div class="modal-header">
            <h3 id="controlModalTitle">操作</h3>
            <button class="btn-icon" onclick="closeControlModal()">×</button>
        </div>
        <div class="modal-body" id="controlModalBody">
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="closeControlModal()">取消</button>
            <button class="btn primary" id="controlModalSubmit" onclick="submitControl()">确认</button>
        </div>
    </div>

    <div class="drawer-mask" id="drawerMask" onclick="closeDrawer()"></div>
    <div class="drawer" id="drilldownDrawer">
        <div class="drawer-header">
            <div>
                <div class="panel-title" id="drawerTitle">详情</div>
                <div class="panel-sub" id="drawerSub">-</div>
            </div>
            <button class="btn" onclick="closeDrawer()">关闭</button>
        </div>
        <div class="drawer-body" id="drawerBody"></div>
    </div>

    <script>

        const API_BASE = "";
        let charts = {};
        let dashboardData = null;
        let selectedUser = null;
        let markedUsers = new Set();


        function handleControl(action) {
            let title = '';
            let content = '';
            let submitAction = 'submitControl()';
            let submitText = '确认';

            if (action === 'maintenance') {
                title = '维护模式';
                content = `
                <div class="form-group">
                    <label>维护状态</label>
                    <select class="select" style="width: 100%;" id="maintenanceStatus" onchange="syncMaintenanceReject()">
                        <option value="off">关闭维护模式 (正常运行)</option>
                        <option value="on">开启维护模式 (仅白名单可用)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>维护公告</label>
                    <input class="input" style="width: 100%;" id="maintenanceNotice" value="服务器维护中，预计恢复时间：12:00">
                </div>
                <div class="form-group">
                    <label>拒绝新数据</label>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <button class="btn" id="maintenanceRejectBtn" onclick="toggleMaintenanceReject()">已关闭</button>
                        <div class="muted" id="maintenanceRejectHint">维护开启时可拒绝新数据</div>
                    </div>
                    <input type="hidden" id="maintenanceReject" value="off">
                </div>
            `;
            } else if (action === 'alert') {
                title = '发布紧急通知 (弹窗)';
                content = `
                <div class="form-group">
                    <label>状态</label>
                    <select class="select" style="width: 100%;" id="alertStatus">
                        <option value="on">激活 (推送弹窗)</option>
                        <option value="off">禁用 (停止推送)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>通知标题</label>
                    <input class="input" style="width: 100%;" id="alertTitle" placeholder="例如: 停机维护通知">
                </div>
                <div class="form-group">
                    <label>详细内容</label>
                    <textarea class="input" style="width: 100%; height: 100px; font-family: inherit; padding: 10px;" id="alertContent" placeholder="此处内容将以模态框形式展现..."></textarea>
                </div>
                <div class="form-group">
                    <label>推送范围</label>
                    <input class="input" style="width: 100%;" id="alertScope" value="all" placeholder="例如: 2.0.1 或 all">
                </div>
            `;
            } else if (action === 'notice') {
                title = '覆盖公告栏文字';
                content = `
                <div class="form-group">
                    <label>状态</label>
                    <select class="select" style="width: 100%;" id="noticeStatus">
                        <option value="on">激活 (文字覆盖)</option>
                        <option value="off">禁用 (恢复默认)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>公告栏文字</label>
                    <textarea class="input" style="width: 100%; height: 100px; font-family: inherit; padding: 10px;" id="noticeContent" placeholder="在此输入公告内容（支持 HTML 标签，例如 <strong>加粗</strong>）..."></textarea>
                </div>
                <div class="form-group">
                    <label>覆盖范围</label>
                    <input class="input" style="width: 100%;" id="noticeScope" value="all" placeholder="例如: 2.0.1 或 all">
                </div>
            `;
            } else if (action === 'update') {
                title = '更新提示';
                content = `
                <div class="form-group">
                    <label>推送范围 (输入版本号或 'all')</label>
                    <input class="input" style="width: 100%;" id="updateScope" value="all" placeholder="例如: 2.0.1 或 all">
                </div>
                <div class="form-group">
                    <label>推送内容</label>
                    <textarea class="input" style="width: 100%; height: 80px; font-family: inherit; padding: 10px;" id="updateContent" placeholder="请输入版本更新说明..."></textarea>
                </div>
                <div class="form-group">
                    <label>下载地址</label>
                    <input class="input" style="width: 100%;" id="updateUrl" placeholder="请输入下载短链或网盘链接">
                </div>
            `;
            } else if (action === 'test') {
                title = 'JSON 测试接口';
                submitText = '加载测试数据';
                submitAction = 'loadTestDataFromJson()';
                content = `
                <div class="form-group">
                    <label>接口标识</label>
                    <input class="input" style="width: 100%;" value="test.json" readonly>
                </div>
                <div class="form-group">
                    <label>用途说明</label>
                    <textarea class="input" style="width: 100%; height: 80px; font-family: inherit; padding: 10px;" readonly>仅用于前端联调与数据结构校验</textarea>
                </div>
            `;
            } else if (action === 'export') {
                title = '导出数据';
                submitText = '确认导出';
                submitAction = 'exportData()';
                content = `
                <div class="form-group">
                    <label>日期范围</label>
                    <div class="date-range-inputs">
                        <input class="input" type="date" id="startDate">
                        <span class="muted">至</span>
                        <input class="input" type="date" id="endDate">
                    </div>
                </div>
                <div class="form-group">
                    <label>文件格式</label>
                    <select class="select" style="width: 100%;" id="exportFormat">
                        <option value="csv">CSV</option>
                        <option value="excel">Excel</option>
                    </select>
                </div>
            `;
            }

            document.getElementById('controlModalTitle').textContent = title;
            document.getElementById('controlModalBody').innerHTML = content;
            document.getElementById('controlModal').dataset.action = action;

            const submitBtn = document.getElementById('controlModalSubmit');
            submitBtn.textContent = submitText;
            submitBtn.setAttribute('onclick', submitAction);

            document.getElementById('controlModalMask').classList.add('show');
            document.getElementById('controlModal').classList.add('show');

            if (action === 'export') {
                const end = new Date();
                const start = new Date();
                start.setDate(start.getDate() - 30);
                document.getElementById('startDate').value = start.toISOString().split('T')[0];
                document.getElementById('endDate').value = end.toISOString().split('T')[0];
            }
            if (action === 'maintenance') {
                syncMaintenanceReject();
            }
        }

        function closeControlModal() {
            document.getElementById('controlModalMask').classList.remove('show');
            document.getElementById('controlModal').classList.remove('show');
        }

        async function submitControl() {
            const action = document.getElementById('controlModal').dataset.action;

            // 本地功能直接处理
            if (action === 'test') {
                loadTestDataFromJson();
                closeControlModal();
                return;
            }
            if (action === 'export') {
                exportData();
                closeControlModal();
                return;
            }

            // 构建请求载荷
            const payload = { action };
            if (action === 'maintenance') {
                payload.maintenance = document.getElementById('maintenanceStatus').value === 'on';
                payload.maintenance_msg = document.getElementById('maintenanceNotice').value;
                payload.stop_new_data = document.getElementById('maintenanceReject').value === 'on';
            } else if (action === 'alert') {
                payload.alert_active = document.getElementById('alertStatus').value === 'on';
                payload.title = document.getElementById('alertTitle').value;
                payload.content = document.getElementById('alertContent').value;
                payload.scope = document.getElementById('alertScope').value;
            } else if (action === 'notice') {
                payload.notice_active = document.getElementById('noticeStatus').value === 'on';
                payload.content = document.getElementById('noticeContent').value;
                payload.scope = document.getElementById('noticeScope').value;
            } else if (action === 'update') {
                payload.content = document.getElementById('updateContent').value;
                payload.url = document.getElementById('updateUrl').value;
                payload.scope = document.getElementById('updateScope').value;
            }

            const btn = document.getElementById('controlModalSubmit');
            const originalText = btn.textContent;
            btn.textContent = '提交中...';
            btn.disabled = true;

            try {
                const res = await fetch(`${API_BASE}/admin/control`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) throw new Error('操作失败，服务器返回 ' + res.status);

                await res.json(); // 等待响应体
                closeControlModal();
                showAlert('指令已下发成功', 'success');
            } catch (error) {
                console.error(error);
                showAlert(error.message, 'danger');
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        function toggleMaintenanceReject() {
            const btn = document.getElementById('maintenanceRejectBtn');
            const hidden = document.getElementById('maintenanceReject');
            if (!btn || !hidden || btn.disabled) return;
            const next = hidden.value === 'on' ? 'off' : 'on';
            hidden.value = next;
            btn.textContent = next === 'on' ? '已开启' : '已关闭';
            btn.classList.toggle('primary', next === 'on');
        }

        function syncMaintenanceReject() {
            const status = document.getElementById('maintenanceStatus')?.value;
            const btn = document.getElementById('maintenanceRejectBtn');
            const hint = document.getElementById('maintenanceRejectHint');
            const hidden = document.getElementById('maintenanceReject');
            if (!btn || !hidden) return;
            const enabled = status === 'on';
            btn.disabled = !enabled;
            if (!enabled) {
                hidden.value = 'off';
                btn.textContent = '已关闭';
                btn.classList.remove('primary');
            }
            if (hint) {
                hint.textContent = enabled ? '开启后服务器拒绝接收新数据' : '维护开启时可拒绝新数据';
            }
        }

        const colors = {
            primary: '#2563eb',
            secondary: '#10b981',
            warning: '#f59e0b',
            danger: '#ef4444',
            muted: '#94a3b8'
        };
        const TEST_USERS = [
            { uid: 'bd45...f12a', nickname: 'user01', os: 'Windows 11', cpu: 16, locale: 'zh-CN', time: '2026-01-29' },
            { uid: 'ce78...a34b', nickname: 'user02', os: 'Windows 10', cpu: 8, locale: 'en-US', time: '2026-01-29' },
            { uid: 'df12...e56c', nickname: 'user03', os: 'Windows 11', cpu: 24, locale: 'zh-TW', time: '2026-01-30' },
            { uid: 'ea89...d78e', nickname: 'user04', os: 'Windows 11', cpu: 4, locale: 'zh-CN', time: '2026-01-28' },
            { uid: 'fb56...c90f', nickname: 'user05', os: 'Windows 10', cpu: 12, locale: 'ja-JP', time: '2026-01-30' }
        ];

        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
            setDefaultDates();
            fetchData();
            setInterval(fetchData, 60000);
        });

        function initCharts() {
            const ids = ['growthChart', 'newVsDauChart', 'osChart', 'archChart', 'versionChart', 'localeChart'];
            ids.forEach(id => {
                const dom = document.getElementById(id);
                if (dom) {
                    charts[id] = echarts.init(dom, null, { renderer: 'canvas' });
                }
            });

            window.addEventListener('resize', debounce(() => {
                Object.values(charts).forEach(chart => chart && chart.resize());
            }, 200));

            bindDrilldown();
        }

        function debounce(fn, wait) {
            let timer;
            return (...args) => {
                clearTimeout(timer);
                timer = setTimeout(() => fn(...args), wait);
            };
        }

        function setDefaultDates() {
            const today = new Date();
            const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
            const lastPeriodStart = new Date(today.getFullYear(), today.getMonth() - 2, today.getDate());
            document.getElementById('endDate').value = formatDate(today);
            document.getElementById('startDate').value = formatDate(lastMonth);
            document.getElementById('compareEnd').value = formatDate(lastMonth);
            document.getElementById('compareStart').value = formatDate(lastPeriodStart);
        }

        function buildTestDataFromUsers(users) {
            const total = users.length;
            const growthData = buildGrowthDataFromUsers(users);
            const todayNew = growthData.length ? growthData[growthData.length - 1].new_count : total;
            return {
                total_users: total,
                total_users_growth: 0,
                online_users: total,
                today_new: todayNew,
                today_new_growth: 0,
                dau: total,
                dau_growth: 0,
                growth_data: growthData,
                compare_growth_data: [],
                os_stats: buildStatsByKey(users, 'os'),
                arch_stats: [{ name: '未知', value: total }],
                version_stats: [{ name: 'v3Beta', value: total }],
                locale_stats: buildStatsByKey(users, 'locale'),
                recent_users: users.map((user, index) => ({
                    nickname: user.nickname || `user${index + 1}`,
                    os: user.os || '-',
                    arch: '-',
                    version: 'v3Beta',
                    hwid: user.uid || '-',
                    python_version: '-',
                    locale: user.locale || '-',
                    minutes_ago: getMinutesAgo(user.time),
                    updated_at: user.time || '-'
                }))
            };
        }

        function buildGrowthDataFromUsers(users) {
            const map = new Map();
            users.forEach(user => {
                const date = user.time;
                if (!date) return;
                const entry = map.get(date) || { date, count: 0, dau: 0, new_count: 0 };
                entry.count += 1;
                entry.dau += 1;
                entry.new_count += 1;
                map.set(date, entry);
            });
            return Array.from(map.values()).sort((a, b) => a.date.localeCompare(b.date));
        }

        function buildStatsByKey(users, key) {
            const map = new Map();
            users.forEach(user => {
                const value = user[key] || '未知';
                map.set(value, (map.get(value) || 0) + 1);
            });
            return Array.from(map.entries())
                .map(([name, value]) => ({ name, value }))
                .sort((a, b) => b.value - a.value);
        }

        function getMinutesAgo(dateStr) {
            if (!dateStr) return '-';
            const parsed = new Date(`${dateStr}T00:00:00`);
            if (Number.isNaN(parsed.getTime())) return '-';
            const diff = Date.now() - parsed.getTime();
            return Math.max(0, Math.floor(diff / 60000));
        }

        async function fetchData() {
            const params = buildStatsParams();
            setRefreshing(true);
            try {
                const response = await fetch(`${API_BASE}/admin/stats?${params}`);
                if (!response.ok) throw new Error('Failed to fetch');
                dashboardData = await response.json();
                updateDashboard(dashboardData);
            } catch (error) {
                loadMockData();
            } finally {
                setRefreshing(false);
            }
        }

        function buildStatsParams() {
            const filters = {

                os: document.getElementById('filterOS').value,
                arch: document.getElementById('filterArch').value,
                version: document.getElementById('filterVersion').value,
                locale: document.getElementById('filterLocale').value,
                range: document.getElementById('trendRange').value
            };

            const compareStart = document.getElementById('compareStart').value;
            const compareEnd = document.getElementById('compareEnd').value;
            if (compareStart && compareEnd) {
                filters.compare_start_date = compareStart;
                filters.compare_end_date = compareEnd;
            }

            const params = new URLSearchParams();
            Object.entries(filters).forEach(([k, v]) => v && params.append(k, v));
            return params.toString();
        }

        function updateDashboard(data) {
            updateStatCards(data);
            renderGrowthChart(data.growth_data || [], data.compare_growth_data || [], data.video_release_date || data.video_release_at);
            renderNewVsDauChart(data.growth_data || [], data.compare_growth_data || []);
            renderPieChart('osChart', data.os_stats || []);
            renderPieChart('archChart', data.arch_stats || []);
            renderPieChart('versionChart', data.version_stats || []);
            renderPieChart('localeChart', data.locale_stats || []);
            renderRecentUsers(data.recent_users || []);

            window.latestUsersData = data.recent_users || [];
            if (document.getElementById('view-userlist').classList.contains('active')) {
                renderUserListView(window.latestUsersData);
            }

            updateFilters(data);
            checkAlerts(data);
            updateTimestamp();
        }

        function updateStatCards(data) {
            setText('totalUsers', formatNumber(data.total_users));
            setText('onlineUsers', formatNumber(data.online_users));
            setText('todayNew', formatNumber(data.today_new));
            setText('dauUsers', formatNumber(data.dau || 0));

            updateTrend('totalUsersTrend', data.total_users_growth ?? 0);
            updateTrend('todayNewTrend', data.today_new_growth ?? 0);
            updateTrend('dauTrend', data.dau_growth ?? 0);

            if (data.total_users > 0) {
                const rate = ((data.online_users / data.total_users) * 100).toFixed(1);
                setText('onlineRate', `在线率 ${rate}%`);
            }
        }

        function updateTrend(id, value) {
            const el = document.getElementById(id);
            const isUp = value >= 0;
            el.className = `trend ${isUp ? 'up' : 'down'}`;
            el.textContent = `${isUp ? '↑' : '↓'} ${Math.abs(value).toFixed(1)}%`;
        }

        function renderGrowthChart(growthData, compareData, releaseDate) {
            if (!growthData.length) return;
            const peak = findPeak(growthData);
            const dates = growthData.map(d => d.date);
            const option = {
                grid: { left: 30, right: 20, top: 20, bottom: 30 },
                tooltip: { trigger: 'axis' },
                xAxis: {
                    type: 'category',
                    data: dates.map(d => d.slice(5)),
                    axisLine: { lineStyle: { color: '#e2e8f0' } },
                    axisLabel: { color: '#64748b', fontSize: 11 }
                },
                yAxis: {
                    type: 'value',
                    min: 1,
                    minInterval: 1,
                    axisLabel: { color: '#94a3b8', fontSize: 11 },
                    splitLine: { lineStyle: { color: '#f1f5f9' } }
                },
                series: [
                    {
                        name: '用户增长',
                        type: 'line',
                        data: growthData.map(d => d.count),
                        smooth: true,
                        symbol: 'circle',
                        symbolSize: 6,
                        lineStyle: { color: colors.primary, width: 3 },
                        itemStyle: { color: colors.primary },
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(37, 99, 235, 0.3)' },
                                { offset: 1, color: 'rgba(37, 99, 235, 0)' }
                            ])
                        },
                        markPoint: {
                            symbol: 'pin',
                            symbolSize: 48,
                            itemStyle: { color: colors.warning },
                            label: {
                                color: '#fff',
                                fontSize: 11,
                                formatter: (params) => formatNumber(params.value)
                            },
                            data: [{
                                name: '峰值',
                                coord: [peak.index, peak.value],
                                value: peak.value
                            }]
                        },
                        sampling: 'lttb',
                        large: true,
                        progressive: 1000
                    }
                ]
            };

            if (compareData && compareData.length) {
                option.series.push({
                    name: '对比周期',
                    type: 'line',
                    data: compareData.map(d => d.count),
                    smooth: true,
                    symbol: 'none',
                    lineStyle: { color: colors.muted, width: 2, type: 'dashed' }
                });
            }

            if (releaseDate) {
                const releaseIndex = dates.findIndex(d => d === releaseDate);
                if (releaseIndex >= 0) {
                    option.series[0].markLine = {
                        symbol: ['none', 'none'],
                        label: { formatter: '视频发布', color: colors.warning },
                        lineStyle: { color: colors.warning, type: 'dashed' },
                        data: [{ xAxis: releaseIndex }]
                    };
                    setText('growthPeakInfo', `峰值 ${peak.date} · 视频发布 ${releaseDate}`);
                } else {
                    setText('growthPeakInfo', `峰值 ${peak.date}`);
                }
            } else {
                setText('growthPeakInfo', `峰值 ${peak.date}`);
            }

            charts.growthChart.setOption(option);
        }

        function renderNewVsDauChart(growthData, compareData) {
            if (!growthData.length) return;
            const dates = growthData.map(d => d.date);
            const option = {
                grid: { left: 35, right: 20, top: 20, bottom: 30 },
                tooltip: { trigger: 'axis' },
                xAxis: {
                    type: 'category',
                    data: dates.map(d => d.slice(5)),
                    axisLabel: { color: '#64748b', fontSize: 11 }
                },
                yAxis: {
                    type: 'value',
                    min: 1,
                    minInterval: 1,
                    axisLabel: { color: '#94a3b8', fontSize: 11 },
                    splitLine: { lineStyle: { color: '#f1f5f9' } }
                },
                series: [
                    {
                        name: '新增用户',
                        type: 'line',
                        data: growthData.map(d => d.new_count ?? d.count),
                        smooth: true,
                        symbol: 'none',
                        lineStyle: { color: colors.secondary, width: 2 }
                    },
                    {
                        name: 'DAU',
                        type: 'line',
                        data: growthData.map(d => d.dau ?? 0),
                        smooth: true,
                        symbol: 'none',
                        lineStyle: { color: colors.primary, width: 2 }
                    }
                ]
            };

            if (compareData && compareData.length) {
                option.series.push({
                    name: '新增对比',
                    type: 'line',
                    data: compareData.map(d => d.new_count ?? d.count),
                    smooth: true,
                    symbol: 'none',
                    lineStyle: { color: colors.muted, width: 1, type: 'dashed' }
                });
            }

            charts.newVsDauChart.setOption(option);
        }

        function renderPieChart(chartId, rawData) {
            if (!rawData.length) return;
            const normalized = normalizePieData(rawData);
            const data = chartId === 'osChart'
                ? normalized.map(item => ({
                    ...item,
                    fullName: item.name,
                    name: simplifyOSName(item.name)
                }))
                : normalized;
            const option = {
                tooltip: {
                    trigger: 'item',
                    formatter: (params) => {
                        const fullName = params.data && params.data.fullName ? params.data.fullName : params.name;
                        return `${fullName}: ${params.value} (${params.percent}%)`;
                    }
                },
                legend: {
                    bottom: 0,
                    icon: 'rect',
                    itemWidth: 10,
                    itemHeight: 10,
                    textStyle: { color: '#64748b', fontSize: 11 }
                },
                series: [{
                    type: 'pie',
                    radius: ['45%', '72%'],
                    center: ['50%', '45%'],
                    label: { color: '#64748b', fontSize: 10 },
                    data: data.map((item, idx) => ({
                        name: item.name,
                        value: item.value,
                        itemStyle: {
                            color: [colors.primary, colors.secondary, colors.warning, colors.danger, '#7c3aed', '#0ea5e9'][idx % 6]
                        }
                    }))
                }]
            };
            charts[chartId].setOption(option);
        }

        function normalizePieData(list) {
            const sorted = [...list].sort((a, b) => b.value - a.value);
            if (sorted.length <= 6) return sorted;
            const top = sorted.slice(0, 5);
            const rest = sorted.slice(5).reduce((sum, item) => sum + item.value, 0);
            if (rest > 0) top.push({ name: '其他', value: rest });
            return top;
        }

        function simplifyOSName(name) {
            if (!name) return '-';
            const lower = name.toLowerCase();
            if (lower.includes('windows')) {
                const match = lower.match(/windows\s*([0-9]+)/);
                if (match) return `Win${match[1]}`;
                if (lower.includes('xp')) return 'WinXP';
                if (lower.includes('vista')) return 'WinVista';
            }
            const winMatch = lower.match(/win\s*([0-9]+)/);
            if (winMatch) return `Win${winMatch[1]}`;
            return name.length > 6 ? name.slice(0, 6) : name;
        }

        function updateFilters(data) {
            updateSelect('filterOS', data.os_options || data.os_stats || []);
            updateSelect('filterArch', data.arch_options || data.arch_stats || []);
            updateSelect('filterVersion', data.version_options || data.version_stats || []);
            updateSelect('filterLocale', data.locale_options || data.locale_stats || []);
        }

        function updateSelect(id, list) {
            const select = document.getElementById(id);
            const current = select.value;
            while (select.options.length > 1) select.remove(1);
            list.forEach(item => {
                const opt = document.createElement('option');
                opt.value = item.name;
                opt.textContent = `${item.name} (${item.value})`;
                select.appendChild(opt);
            });
            select.value = current;
        }

        function applyFilters() {
            fetchData();
        }

        function showExportModal() {
            handleControl('export');
        }

        function closeExportModal() {
            closeControlModal();
        }

        async function exportData() {
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            const format = document.getElementById('exportFormat').value;
            if (!start || !end) {
                showAlert('请选择导出日期范围', 'warning');
                return;
            }
            const params = new URLSearchParams({

                format,
                start_date: start,
                end_date: end
            });
            try {
                const res = await fetch(`${API_BASE}/admin/export?${params}`);
                if (!res.ok) throw new Error('export failed');
                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `telemetry_${start}_${end}.${format === 'excel' ? 'xlsx' : 'csv'}`;
                document.body.appendChild(a);
                a.click();
                URL.revokeObjectURL(url);
                document.body.removeChild(a);
                showAlert('导出完成', 'success');
                closeControlModal();
            } catch (error) {
                showAlert('导出失败', 'danger');
            }
        }

        function checkAlerts(data) {
            const alerts = [];
            if ((data.today_new_growth ?? 0) < -20) {
                alerts.push({ type: 'warning', text: '今日新增环比下降超过20%' });
            }
            if (data.total_users > 0 && data.online_users / data.total_users < 0.05) {
                alerts.push({ type: 'danger', text: '在线率低于5%' });
            }
            if ((data.dau_growth ?? 0) < -15) {
                alerts.push({ type: 'warning', text: '日活环比波动明显' });
            }
            renderAlerts(alerts);
        }

        function renderAlerts(list) {
            const container = document.getElementById('alertContainer');
            container.querySelectorAll('.alert[data-source="system"]').forEach(node => node.remove());
            list.forEach(item => {
                const div = document.createElement('div');
                div.className = `alert ${item.type} show`;
                div.dataset.source = 'system';
                div.textContent = item.text;
                container.appendChild(div);
            });
        }

        function switchView(viewId, menuItem) {
            document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
            if (menuItem) {
                menuItem.classList.add('active');
            }

            document.querySelectorAll('.view-container').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${viewId}`).classList.add('active');

            if (viewId === 'userlist' && window.latestUsersData) {
                renderUserListView(window.latestUsersData);
            }
        }

        async function refreshData() {
            await fetchData();
            showAlert('数据已刷新', 'success');
        }

        function showAlert(text, type) {
            const container = document.getElementById('alertContainer');
            const div = document.createElement('div');
            div.className = `alert ${type}`;
            div.dataset.source = 'toast';
            div.textContent = text;
            container.prepend(div);
            requestAnimationFrame(() => div.classList.add('show'));
            setTimeout(() => {
                div.classList.remove('show');
                setTimeout(() => div.remove(), 280);
            }, 2200);
        }

        function bindDrilldown() {
            const map = {
                osChart: 'os',
                archChart: 'arch',
                versionChart: 'version',
                localeChart: 'locale'
            };
            Object.entries(map).forEach(([chartId, dimension]) => {
                charts[chartId].on('click', params => {
                    openDrilldown(dimension, params.name);
                });
            });
            charts.growthChart.on('click', params => {
                openDrilldown('date', params.name);
            });
        }

        async function openDrilldown(dimension, value) {
            const drawer = document.getElementById('drilldownDrawer');
            const mask = document.getElementById('drawerMask');
            setText('drawerTitle', `${dimension} · ${value}`);
            setText('drawerSub', '加载中...');
            document.getElementById('drawerBody').innerHTML = '';
            drawer.classList.add('show');
            mask.classList.add('show');

            const params = new URLSearchParams({

                dimension,
                value,
                start_date: document.getElementById('startDate').value,
                end_date: document.getElementById('endDate').value
            });
            try {
                const res = await fetch(`${API_BASE}/admin/drilldown?${params}`);
                if (!res.ok) throw new Error('drilldown failed');
                const data = await res.json();
                renderDrilldown(data);
            } catch (error) {
                renderDrilldownFallback(dimension, value);
            }
        }

        function renderDrilldown(data) {
            setText('drawerSub', data.period || '当前筛选范围');
            const body = document.getElementById('drawerBody');
            body.innerHTML = '';
            if (Array.isArray(data.items)) {
                data.items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'drawer-card';
                    div.innerHTML = `<span>${item.name}</span><span>${formatNumber(item.value)}</span>`;
                    body.appendChild(div);
                });
            }
            if (Array.isArray(data.metrics)) {
                data.metrics.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'drawer-card';
                    div.innerHTML = `<span>${item.label}</span><span>${formatNumber(item.value)}</span>`;
                    body.appendChild(div);
                });
            }
        }

        function renderDrilldownFallback(dimension, value) {
            setText('drawerSub', '当前筛选范围');
            const body = document.getElementById('drawerBody');
            body.innerHTML = '';
            const base = [
                { label: '用户数', value: Math.floor(Math.random() * 10000) + 200 },
                { label: '在线用户', value: Math.floor(Math.random() * 800) + 20 },
                { label: '今日新增', value: Math.floor(Math.random() * 300) + 10 }
            ];
            base.forEach(item => {
                const div = document.createElement('div');
                div.className = 'drawer-card';
                div.innerHTML = `<span>${value} · ${item.label}</span><span>${formatNumber(item.value)}</span>`;
                body.appendChild(div);
            });
        }

        function closeDrawer() {
            document.getElementById('drilldownDrawer').classList.remove('show');
            document.getElementById('drawerMask').classList.remove('show');
        }

        function normalizeUserName(value) {
            if (value === undefined || value === null) return '';
            const text = String(value).trim();
            if (!text || text === '-') return '';
            return text;
        }

        function getAutoUserName(item) {
            return item.nickname || item.user || `user${item.id || '?'}`;
        }

        function getDisplayUserName(item) {
            const alias = normalizeUserName(item.alias);
            const nickname = normalizeUserName(item.nickname);
            const user = normalizeUserName(item.user);
            const autoName = getAutoUserName(item);

            if (alias) return alias;
            return nickname || user || autoName;
        }

        function renderRecentUsers(list) {
            const container = document.getElementById('recentUsersList');
            container.innerHTML = '';
            const fullList = list.length ? list : buildTestDataFromUsers(TEST_USERS).recent_users;

            fullList.sort((a, b) => {
                const t1 = new Date(a.updated_at).getTime();
                const t2 = new Date(b.updated_at).getTime();
                if (isNaN(t1)) return 1;
                if (isNaN(t2)) return -1;
                return t2 - t1;
            });

            const data = fullList.slice(0, 10);

            data.forEach((item, index) => {
                const div = document.createElement('div');
                const label = getDisplayUserName(item);
                const hwid = item.hwid || item.hwid_hash || '-';
                const displayHwid = formatHwid(hwid);
                const os = item.os || '-';
                const arch = item.arch || '-';
                const version = item.version || '-';
                const minutes = item.minutes_ago ?? item.minutes ?? item.last_seen_minutes ?? '-';

                const isOnline = typeof minutes === 'number' && minutes <= 5;
                const statusClass = isOnline ? 'online' : 'offline';

                div.className = 'recent-item';
                div.innerHTML = `
                <div class="recent-avatar" style="background: ${isOnline ? 'var(--secondary)' : 'var(--muted)'};">${getAutoUserName(item).replace('user', 'U')}</div>
                <div class="recent-main">
                    <div class="recent-name">
                        <span class="status-dot ${statusClass}"></span>
                        <span style="color: var(--text-muted); font-size: 0.85em; font-weight: normal; margin-right: 4px;">#${item.id || '-'}</span>
                        ${label}
                    </div>
                    <div class="recent-meta">${os} · ${arch} · ${version}</div>
                    <div class="recent-meta">HWID: ${displayHwid}</div>
                </div>
                <div class="recent-time">${formatTimeAgo(minutes)}</div>
            `;
                div.addEventListener('click', () => {
                    selectRecentUser(item, index);
                });
                container.appendChild(div);
            });
            const defaultUser = selectedUser || data[0];
            if (defaultUser) {
                selectRecentUser(defaultUser, data.indexOf(defaultUser));
            }
        }

        function renderUserListView(list) {
            const tbody = document.getElementById('fullUserListBody');
            tbody.innerHTML = '';
            const fullList = list.length ? list : buildTestDataFromUsers(TEST_USERS).recent_users;

            fullList.sort((a, b) => {
                const t1 = new Date(a.updated_at).getTime();
                const t2 = new Date(b.updated_at).getTime();
                if (isNaN(t1)) return 1;
                if (isNaN(t2)) return -1;
                return t2 - t1;
            });

            fullList.forEach((item, index) => {
                const tr = document.createElement('tr');
                const hwid = item.hwid || item.hwid_hash || '-';
                const displayHwid = formatHwid(hwid);
                const os = item.os || '-';
                const version = item.version || '-';

                const originalName = getAutoUserName(item);
                const alias = normalizeUserName(item.alias);
                let nameHtml = getDisplayUserName(item); // Use getDisplayUserName for consistency
                if (alias && alias !== originalName) { // Only show original name if alias is different
                    nameHtml = `${alias} <span style="color: var(--text-muted); font-weight: normal; font-size: 0.9em;">(${originalName})</span>`;
                }


                const localeCode = item.locale || '-';
                const localeMap = {
                    'zh-CN': '中国',
                    'zh-TW': '中国台湾',
                    'zh-HK': '中国香港',
                    'en-US': '美国',
                    'en-GB': '英国',
                    'ja-JP': '日本',
                    'ko-KR': '韩国',
                    'ru-RU': '俄罗斯',
                    'de-DE': '德国',
                    'fr-FR': '法国'
                };
                const localeDisplay = localeMap[localeCode] || localeCode;

                const minutes = item.minutes_ago ?? item.minutes ?? item.last_seen_minutes ?? '-';

                const isOnline = typeof minutes === 'number' && minutes <= 5;
                const statusClass = isOnline ? 'online' : 'offline';
                const statusText = isOnline ? '在线' : '离线';

                const isMarked = markedUsers.has(hwid);
                const nameStyle = isMarked ? 'color: #f59e0b; font-weight: bold;' : '';
                const hwidStyle = 'font-family: monospace; font-size: 12px;';

                tr.style.cursor = 'pointer';
                tr.onclick = () => openUserDetail(item);

                tr.innerHTML = `
                <td>
                    <div style="display: flex; align-items: center; ${nameStyle}">
                        <div class="recent-avatar" style="width: 32px; height: 32px; font-size: 11px; margin-right: 8px; flex-shrink: 0;">#${item.id || '-'}</div>
                        <span>${nameHtml}</span>
                    </div>
                </td>
                <td style="${hwidStyle}" class="hwid-cell" title="${hwid}" onclick="copyHwid('${hwid}', event)">${displayHwid}</td>
                <td>${version}</td>
                <td>${os}</td>
                <td>${localeDisplay}</td>
                <td>${formatTimeAgo(minutes)}</td>
                <td>
                    <div style="display: flex; align-items: center;">
                        <span class="status-dot ${statusClass}"></span>
                        <span>${statusText}</span>
                    </div>
                </td>
            `;
                tbody.appendChild(tr);
            });
        }

        function openUserDetail(user) {
            const menuItems = document.querySelectorAll('.menu-item');
            let detailMenuItem = null;
            menuItems.forEach(item => {
                if (item.getAttribute('onclick') && item.getAttribute('onclick').includes("'userdetail'")) {
                    detailMenuItem = item;
                }
            });

            selectedUser = user;
            switchView('userdetail', detailMenuItem);
            renderUserDetailView(user);
        }

        function renderUserDetailView(user) {
            const container = document.getElementById('userDetailContent');
            if (!user) return;

            const osName = user.os || '-';
            const osVersion = user.os_version || user.osVersion || '-';
            const osBuild = user.os_build || user.osBuild || '-';
            const arch = user.arch || '-';
            const version = user.version || user.app_version || user.client_version || '-';
            const hwid = user.hwid || user.hwid_hash || '-';
            const displayHwid = formatHwid(hwid);
            const pythonVersion = user.python_version || user.python || '-';
            const localeCode = user.locale || user.region || '-';
            const lastSeen = user.updated_at || user.last_seen || user.last_seen_at || '-';
            const registerTime = getUserRegisterTime(user);
            const minutes = user.minutes_ago ?? user.minutes ?? user.last_seen_minutes ?? '-';
            const resolution = user.resolution || user.screen_resolution || user.screenResolution || '-';

            const originalName = getAutoUserName(user);
            const alias = normalizeUserName(user.alias);
            let displayName = getDisplayUserName(user); // Use getDisplayUserName for consistency
            if (alias && alias !== originalName) { // Only show original name if alias is different
                displayName = `${alias} <span style="color: var(--text-muted); font-size: 0.8em; font-weight: normal;">(${originalName})</span>`;
            }


            const localeMap = {
                'zh-CN': '中国',
                'zh-TW': '中国台湾',
                'zh-HK': '中国香港',
                'en-US': '美国',
                'en-GB': '英国',
                'ja-JP': '日本',
                'ko-KR': '韩国',
                'ru-RU': '俄罗斯',
                'de-DE': '德国',
                'fr-FR': '法国'
            };
            const localeDisplay = localeMap[localeCode] || localeCode;

            const isOnline = typeof minutes === 'number' && minutes <= 5;
            const statusClass = isOnline ? 'online' : 'offline';
            const statusText = isOnline ? '在线' : '离线';
            const statusColor = isOnline ? 'var(--secondary)' : 'var(--danger)';

            const isMarked = markedUsers.has(hwid);
            const starIcon = isMarked
                ? `<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>`
                : `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>`;
            const markText = isMarked ? '取消标记' : '标记用户';
            const markColor = isMarked ? '#f59e0b' : 'var(--text)';

            const sections = [
                {
                    title: '基础信息',
                    items: [
                        { label: '用户 ID (数字)', value: `<b style="color: var(--primary);"># ${user.id || '-'}</b>` },
                        { label: '用户昵称', value: displayName },
                        { label: '在线状态', value: `<span class="status-dot ${statusClass}"></span>${statusText}` },
                        { label: '最近活跃', value: formatTimeAgo(minutes) },
                        { label: '最后更新', value: lastSeen },
                        { label: '注册时间', value: registerTime },
                        { label: '区域', value: localeDisplay }
                    ]
                },
                {
                    title: '设备信息',
                    items: [
                        { label: '操作系统', value: osName },
                        { label: '系统版本', value: osVersion },
                        { label: '构建版本', value: osBuild },
                        { label: '系统架构', value: arch },
                        { label: '屏幕分辨率', value: resolution },
                        { label: 'HWID', value: `<span style="font-family: monospace;">${displayHwid}</span>` }
                    ]
                },
                {
                    title: '应用环境',
                    items: [
                        { label: '客户端版本', value: version },
                        { label: 'Python环境', value: pythonVersion }
                    ]
                }
            ];

            let html = `
            <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 30px; border-bottom: 1px solid var(--border); padding-bottom: 20px;">
                <div style="width: 64px; height: 64px; background: linear-gradient(135deg, #1d4ed8, #3b82f6); border-radius: 16px; color: #fff; font-size: 24px; font-weight: bold; display: flex; align-items: center; justify-content: center;">
                    ${(alias || originalName).substring(0, 1).toUpperCase()}
                </div>
                <div>
                    <h2 style="margin-bottom: 4px; font-size: 24px;">${displayName}</h2>
                    <div style="display: flex; align-items: center; gap: 12px; font-size: 14px; color: var(--text-muted);">
                        <div style="display: flex; align-items: center;">
                            <span class="status-dot ${statusClass}"></span>
                            <span style="color: ${statusColor}; font-weight: 500;">${statusText}</span>
                        </div>
                        <div>Numeric ID: #${user.id || '-'}</div>
                        <div>HWID: ${displayHwid}</div>
                    </div>
                </div>
            </div>

            <div style="margin-bottom: 30px; background: #fff; border-radius: 12px; border: 1px solid var(--border); padding: 20px;">
                <h4 style="margin-bottom: 16px; font-size: 16px; font-weight: 600; color: var(--text); display: flex; align-items: center; gap: 8px;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>
                    管理功能
                </h4>
                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <button class="btn" onclick="updateUserAlias('${hwid}')" style="display: flex; align-items: center; gap: 6px;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                        添加备注
                    </button>
                    <button class="btn" onclick="sendPopup('${hwid}')" style="display: flex; align-items: center; gap: 6px;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                        发送弹窗
                    </button>
                    <button class="btn" onclick="sendNotification('${hwid}')" style="display: flex; align-items: center; gap: 6px;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
                        发送提示
                    </button>
                    <button class="btn" onclick="showAlert('已请求上传日志', 'success')" style="display: flex; align-items: center; gap: 6px;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                        请求上传日志
                    </button>
                    <button class="btn" onclick="toggleMarkUser('${hwid}')" style="display: flex; align-items: center; gap: 6px; border-color: ${markColor}; color: ${markColor};">
                        ${starIcon}
                        ${markText}
                    </button>
                    <button class="btn" onclick="deleteUser('${hwid}')" style="display: flex; align-items: center; gap: 6px; background: var(--danger); border-color: var(--danger); color: white;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                        删除用户
                    </button>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px;">
        `;

            sections.forEach(section => {
                html += `
                <div class="detail-section" style="background: #f8fafc; padding: 20px; border-radius: 12px; border: 1px solid var(--border);">
                    <h4 style="margin-bottom: 16px; font-size: 16px; font-weight: 600; color: var(--text);">${section.title}</h4>
                    <div style="display: grid; gap: 12px;">
            `;
                section.items.forEach(item => {
                    html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; font-size: 14px;">
                        <span style="color: var(--text-muted);">${item.label}</span>
                        <span style="font-weight: 500; text-align: right;">${item.value}</span>
                    </div>
                `;
                });
                html += `
                    </div>
                </div>
            `;
            });

            html += `</div>`;
            container.innerHTML = html;
        }

        async function updateUserAlias(hwid) {
            const user = (window.latestUsersData || []).find(u => u.hwid === hwid);
            const currentAlias = user ? (user.alias || '') : '';
            const newAlias = prompt('请输入备注名称：', currentAlias);
            if (newAlias !== null) {
                try {
                    const res = await fetch(`${API_BASE}/admin/update-alias`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            machine_id: hwid,
                            alias: newAlias.trim()
                        })
                    });
                    if (res.ok) {
                        showAlert('备注已更新', 'success');
                        await fetchData();
                        if (selectedUser && selectedUser.hwid === hwid) {
                            const updated = (window.latestUsersData || []).find(u => u.hwid === hwid);
                            if (updated) renderUserDetailView(updated);
                        }
                    } else throw new Error();
                } catch (e) {
                    showAlert('更新失败', 'danger');
                }
            }
        }

        async function sendPopup(hwid) {
            const msg = prompt('请输入弹窗内容：');
            if (msg) {
                try {
                    const res = await fetch(`${API_BASE}/admin/user-command`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            machine_id: hwid,
                            command: JSON.stringify({ type: 'popup', message: msg })
                        })
                    });
                    if (res.ok) showAlert('弹窗指令已下发', 'success');
                    else throw new Error();
                } catch (e) {
                    showAlert('发送失败', 'danger');
                }
            }
        }

        async function sendNotification(hwid) {
            const msg = prompt('请输入提示内容：');
            if (msg) {
                try {
                    const res = await fetch(`${API_BASE}/admin/user-command`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            machine_id: hwid,
                            command: JSON.stringify({ type: 'toast', message: msg })
                        })
                    });
                    if (res.ok) showAlert('提示指令已下发', 'success');
                    else throw new Error();
                } catch (e) {
                    showAlert('发送失败', 'danger');
                }
            }
        }

        async function deleteUser(hwid) {
            if (confirm('确定要删除该用户吗？此操作不可恢复。')) {
                try {
                    const res = await fetch(`${API_BASE}/admin/delete-user`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ machine_id: hwid })
                    });
                    if (res.ok) {
                        showAlert('用户已删除', 'success');
                        fetchData();
                        switchView('userlist');
                    } else throw new Error();
                } catch (e) {
                    showAlert('删除失败', 'danger');
                }
            }
        }

        function toggleMarkUser(hwid) {
            if (markedUsers.has(hwid)) {
                markedUsers.delete(hwid);
                showAlert('已取消标记', 'success');
            } else {
                markedUsers.add(hwid);
                showAlert('已标记用户', 'warning');
            }

            if (selectedUser && selectedUser.hwid === hwid) {
                renderUserDetailView(selectedUser);
            }

            if (window.latestUsersData) {
                renderUserListView(window.latestUsersData);
            }
        }

        function selectRecentUser(user, index) {
            selectedUser = user;
            const items = document.querySelectorAll('#recentUsersList .recent-item');
            items.forEach((item, idx) => {
                item.classList.toggle('active', idx === index);
            });
            renderUserDetail(user);
        }

        function renderUserDetail(user) {
            const grid = document.getElementById('userDetailGrid');
            const osName = user.os || '-';
            const osVersion = user.os_version || user.osVersion || '-';
            const osBuild = user.os_build || user.osBuild || '-';
            const arch = user.arch || '-';
            const version = user.version || user.app_version || user.client_version || '-';
            const hwid = user.hwid || user.hwid_hash || '-';
            const displayHwid = formatHwid(hwid);
            const pythonVersion = user.python_version || user.python || '-';
            const locale = user.locale || user.region || '-';
            const lastSeen = user.updated_at || user.last_seen || user.last_seen_at || '-';
            const registerTime = getUserRegisterTime(user);
            const minutes = user.minutes_ago ?? user.minutes ?? user.last_seen_minutes ?? '-';
            const resolution = user.resolution || user.screen_resolution || user.screenResolution || '-';
            setText('userDetailSub', `${getAutoUserName(user)} · ${formatTimeAgo(minutes)}`);
            const items = [
                { label: 'HWID', value: displayHwid },
                { label: '软件版本', value: version },
                { label: '系统', value: osName },
                { label: '系统版本', value: osVersion },
                { label: '系统构建', value: osBuild },
                { label: '架构', value: arch },
                { label: '屏幕分辨率', value: resolution },
                { label: 'Python版本', value: pythonVersion },
                { label: '区域', value: locale },
                { label: '注册时间', value: registerTime },
                { label: '最近省心', value: lastSeen }
            ];
            const content = items.map(item => `
            <div class="detail-card">
                <div class="detail-label">${item.label}</div>
                <div class="detail-value">${item.value}</div>
            </div>
        `).join('');
            grid.classList.add('switching');
            requestAnimationFrame(() => {
                setTimeout(() => {
                    grid.innerHTML = content;
                    grid.classList.remove('switching');
                }, 140);
            });
        }

        function updateTimestamp() {
            const now = new Date();
            setText('lastUpdate', `最近更新 ${now.toLocaleTimeString('zh-CN', { hour12: false })}`);
        }

        function findPeak(list) {
            let peakValue = -Infinity;
            let peakIndex = 0;
            list.forEach((item, index) => {
                if (item.count > peakValue) {
                    peakValue = item.count;
                    peakIndex = index;
                }
            });
            return { value: peakValue, index: peakIndex, date: list[peakIndex].date };
        }

        function formatTimeAgo(minutes) {
            if (minutes === '-' || minutes === undefined || minutes === null) return '-';
            const m = parseInt(minutes, 10);
            if (isNaN(m)) return minutes;

            if (m < 60) {
                return `${m} 分钟前`;
            }
            const hours = Math.floor(m / 60);
            const mins = m % 60;
            if (mins === 0) {
                return `${hours} 小时前`;
            }
            return `${hours} 小时 ${mins} 分钟前`;
        }

        function formatNumber(num) {
            if (num === undefined || num === null) return '-';
            return Number(num).toLocaleString('zh-CN');
        }

        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        function setText(id, text) {
            const el = document.getElementById(id);
            if (el) el.textContent = text;
        }

        function setRefreshing(active) {
            const app = document.querySelector('.app');
            if (app) app.classList.toggle('refreshing', active);
            const refreshBtn = document.getElementById('refreshBtn');
            if (refreshBtn) refreshBtn.classList.toggle('loading', active);
        }

        function formatHwid(hwid) {
            if (!hwid || hwid === '-') return '-';
            const text = String(hwid);
            if (text.length <= 10) return text;
            return `${text.slice(0, 5)}......${text.slice(-5)}`;
        }

        function getUserRegisterTime(user) {
            return user.registered_at || user.created_at || user.first_seen || user.first_seen_at || user.time || user.updated_at || user.last_seen || user.last_seen_at || '-';
        }

        function showHwidToast(x, y, text) {
            const toast = document.createElement('div');
            toast.className = 'hwid-toast';
            toast.textContent = text;
            document.body.appendChild(toast);
            const rect = toast.getBoundingClientRect();
            const left = Math.min(Math.max(8, x - rect.width / 2), window.innerWidth - rect.width - 8);
            const top = Math.min(Math.max(8, y - rect.height - 12), window.innerHeight - rect.height - 8);
            toast.style.left = `${left}px`;
            toast.style.top = `${top}px`;
            requestAnimationFrame(() => toast.classList.add('show'));
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 200);
            }, 1000);
        }

        async function copyHwid(hwid, event) {
            if (event) event.stopPropagation();
            if (!hwid || hwid === '-') return;
            const text = String(hwid);
            try {
                if (navigator.clipboard && window.isSecureContext) {
                    await navigator.clipboard.writeText(text);
                } else {
                    const input = document.createElement('textarea');
                    input.value = text;
                    input.style.position = 'fixed';
                    input.style.opacity = '0';
                    document.body.appendChild(input);
                    input.focus();
                    input.select();
                    document.execCommand('copy');
                    document.body.removeChild(input);
                }
                const x = event ? event.clientX : window.innerWidth / 2;
                const y = event ? event.clientY : window.innerHeight / 2;
                showHwidToast(x, y, '已复制');
            } catch (error) {
                const x = event ? event.clientX : window.innerWidth / 2;
                const y = event ? event.clientY : window.innerHeight / 2;
                showHwidToast(x, y, '复制失败');
            }
        }

        function applyTestUsers(users) {
            const normalizedUsers = users.map(user => ({
                uid: user.uid || user.hwid || user.id || '-',
                nickname: user.nickname || user.user || user.name || '-',
                os: user.os || user.system || '未知',
                arch: user.arch || user.cpu_arch || '未知',
                version: user.version || user.app_version || 'v3Beta',
                locale: user.locale || user.lang || '未知',
                time: user.time || user.updated_at || user.last_seen || user.date || '-'
            }));
            const data = buildTestDataFromUsers(normalizedUsers);
            data.os_options = buildStatsByKey(normalizedUsers, 'os');
            data.arch_options = buildStatsByKey(normalizedUsers, 'arch');
            data.version_options = buildStatsByKey(normalizedUsers, 'version');
            data.locale_options = buildStatsByKey(normalizedUsers, 'locale');
            updateDashboard(data);
        }

        function readTestJsonFromFile() {
            return new Promise(resolve => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json,application/json';
                input.onchange = async () => {
                    const file = input.files && input.files[0];
                    if (!file) {
                        showAlert('未选择测试文件', 'warning');
                        resolve(null);
                        return;
                    }
                    try {
                        const text = await file.text();
                        resolve(JSON.parse(text));
                    } catch (error) {
                        showAlert('测试数据格式不正确', 'danger');
                        resolve(null);
                    }
                };
                input.click();
            });
        }

        async function loadTestDataFromJson() {
            try {
                let payload = null;
                try {
                    const response = await fetch('test.json', { cache: 'no-store' });
                    if (response.ok) {
                        payload = await response.json();
                    }
                } catch (error) {
                    payload = null;
                }
                if (!payload) {
                    payload = await readTestJsonFromFile();
                }
                if (!payload) return;
                const users = Array.isArray(payload) ? payload : (payload.users || []);
                if (!users.length) {
                    showAlert('测试数据为空', 'warning');
                    return;
                }
                applyTestUsers(users);
                showAlert('测试数据已加载', 'success');
                closeControlModal();
            } catch (error) {
                showAlert('测试接口不可用', 'danger');
            }
        }

        function loadMockData() {
            const filters = {
                os: document.getElementById('filterOS').value,
                arch: document.getElementById('filterArch').value,
                version: document.getElementById('filterVersion').value,
                locale: document.getElementById('filterLocale').value,
                range: parseInt(document.getElementById('trendRange').value || '30')
            };

            const normalizedUsers = TEST_USERS.map(u => ({
                ...u,
                os: u.os || '未知',
                arch: u.arch || '未知',
                version: u.version || 'v3Beta',
                locale: u.locale || '未知'
            }));

            const now = new Date();
            const filteredUsers = normalizedUsers.filter(u => {
                if (filters.os && u.os !== filters.os) return false;
                if (filters.arch && u.arch !== filters.arch) return false;
                if (filters.version && u.version !== filters.version) return false;
                if (filters.locale && u.locale !== filters.locale) return false;

                if (u.time) {
                    const userDate = new Date(u.time);
                    const diffTime = Math.abs(now - userDate);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    if (diffDays > filters.range) return false;
                }
                return true;
            });

            const data = buildTestDataFromUsers(filteredUsers);

            data.os_options = buildStatsByKey(normalizedUsers, 'os');
            data.arch_options = buildStatsByKey(normalizedUsers, 'arch');
            data.version_options = buildStatsByKey(normalizedUsers, 'version');
            data.locale_options = buildStatsByKey(normalizedUsers, 'locale');

            updateDashboard(data);
        }
    </script>
</body>

</html>